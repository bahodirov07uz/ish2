{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap Bundle (JS + Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- jQuery yuklash -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

            <!-- Table Start -->
            <div class="container-fluid pt-4 px-4">
                <div class="row g-4">
                    <div class=" ms-auto">
                        <div class="rounded h-100 p-4 shadow-sm">
                            <h6 class="mb-4 text-center">Buyurtmalar Ma'lumotlari</h6>
                            <div class="d-flex">
                                <form method="get" action="" class="m-order u-s-m-b-30">
                                    <label for="filter">Filtrlash:</label>
                                    <select name="filter" id="filter" onchange="this.form.submit()" class="select-box select-box--primary-style">
                                        <option value="Hammasi" {% if request.GET.filter == "Hammasi" %}selected{% endif %}>Hammasi</option>
                                        <option value="last_5" {% if request.GET.filter == "last_5" %}selected{% endif %}>Oxirgi 5 ta</option>
                                        <option value="Kutilmoqda" {% if request.GET.filter == "Kutilmoqda" %}selected{% endif %}>Kutilmoqda</option>
                                        <option value="Yetkazib berildi" {% if request.GET.filter == "Yetkazib berildi" %}selected{% endif %}>Yetkazilgan</option>
                                        <option value="Bekor qilindi" {% if request.GET.filter == "Bekor qilindi" %}selected{% endif %}>Bekor qilingan</option>
                                        <option value="Yetkazib berilyapti" {% if request.GET.filter == "Yetkazib berilyapti" %}selected{% endif %}>Yetkazib berilyapti</option>
                                    </select>
                                </form> 
                                <form method="get" action="" class="m-order u-s-m-b-30">
                                    <label for="filter">Filtrlash:</label>
                                    <select name="viloyat" id="viloyat" onchange="this.form.submit()" class="select-box select-box--primary-style">
                                        <option value="all" {% if request.GET.filter == "all" %}selected{% endif %}>Hammasi</option>
                                        <option value="andijon" {% if request.GET.filter == "andijon" %}selected{% endif %}>Andijon</option>
                                        <option value="namangan" {% if request.GET.filter == "namangan" %}selected{% endif %}>Namangan</option>
                                        <option value="fergana" {% if request.GET.filter == "fergana" %}selected{% endif %}>Farg'ona</option>
                                        <option value="toshkent" {% if request.GET.filter == "toshkent" %}selected{% endif %}>Toshkent</option>
                                        <option value="samarqand" {% if request.GET.filter == "samarqand" %}selected{% endif %}>Samarqand</option>
                                        <option value="sirdaryo" {% if request.GET.filter == "sirdaryo" %}selected{% endif %}>Sirdaryo</option>
                                    </select>
                                </form>     
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">Ism</th>
                                            <th scope="col">Viloyat</th>
                                            <th scope="col">Summa</th>
                                            <th scope="col">Sana</th>
                                            <th scope="col">Soni</th>
                                            <th scope="col">Holat</th>
                                            <th scope="col">Detail</th>

                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for i in object_list %}                            
                                            <tr>                                            
                                                <td>{{ i.user }}</td>
                                                <td>{{ i.delivery_address }}</td>
                                                <td>{{ i.total_price|floatformat:0|intcomma}}</td>
                                                <td>{{ i.created_at }}</td>
                                                <td>{{ i.items.count }}</td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button type="button" class="btn 
                                                            {% if i.status == 'Kutilmoqda' %}btn-warning
                                                            {% elif i.status == 'Yetkazib berilyapti' %}btn-primary
                                                            {% elif i.status == 'Yetkazib berildi' %}btn-success
                                                            {% elif i.status == 'Bekor qilindi' %}btn-danger{% endif %} 
                                                            dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                            {{ i.status }}
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li><a class="dropdown-item change-status" href="#" data-id="{{ i.id }}" data-status="Kutilmoqda">Kutilmoqda</a></li>
                                                            <li><a class="dropdown-item change-status" href="#" data-id="{{ i.id }}" data-status="Yetkazib berilyapti">Yetkazib berilyapti</a></li>
                                                            <li><a class="dropdown-item change-status" href="#" data-id="{{ i.id }}" data-status="Yetkazib berildi">Yetkazib berildi</a></li>
                                                            <li><a class="dropdown-item change-status" href="#" data-id="{{ i.id }}" data-status="Bekor qilindi">Bekor qilindi</a></li>
                                                        </ul>
                                                    </div>
                                                </td>
                                             
                                                <td><a href="{% url 'main:order_detail' i.id%}"><button class="btn btn-danger">Detail</button></a></td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>                       
                        </div>
                    </div>
                </div>
            </div>
            <script>
                $(document).ready(function() {
                    $(".change-status").on("click", function(e) {
                        e.preventDefault();
                        var orderId = $(this).data("id"); // Mahsulot ID
                        var newStatus = $(this).data("status"); // Yangi status
                        var button = $(this).closest(".btn-group").find("button"); // Asosiy button
                
                        $.ajax({
                            url: "/yangilash-statusni/", // Backend endpoint
                            type: "POST",
                            data: {
                                'id': orderId,
                                'status': newStatus,
                                'csrfmiddlewaretoken': '{{ csrf_token }}'
                            },
                            success: function(response) {
                                button.text(newStatus); // Button matnini yangilash
                                button.removeClass("btn-warning btn-primary btn-success btn-danger"); // Eski rangni o‘chirish
                
                                // Yangi statusga mos rang berish
                                if (newStatus === "Kutilmoqda") {
                                    button.addClass("btn-warning");
                                } else if (newStatus === "Yetkazib berilyapti") {
                                    button.addClass("btn-primary");
                                } else if (newStatus === "Yetkazib berildi") {
                                    button.addClass("btn-success");
                                } else if (newStatus === "Bekor qilindi") {
                                    button.addClass("btn-danger");
                                }
                            },
                            error: function() {
                                alert("Xatolik yuz berdi. Qayta urinib ko‘ring.");
                            }
                        });
                    });
                });
                </script>   
{% endblock content %}
