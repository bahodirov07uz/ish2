{% extends 'base.html'%}
{% load static %}
{% load custom_filters %}
{% load humanize %}
{% block content %}

<body class="g-sidenav-show  bg-gray-100">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>


  <!-- End Navbar -->
  <div class="container-fluid py-4">
    <div class="row">
      <div class="col-lg-12">
        <div class="row">
          <!-- Chart Section (Left Side) -->
          <div class="col-lg-8">
            <div class="card z-index-2 h-100">
              <div class="card-header pb-0">
                <h6>Sales overview</h6>
                <p class="text-sm">
                  <i class="fa fa-arrow-up text-success"></i>
                  <span class="font-weight-bold">+{{foiz}}%</span> {{oy_nomi}} oyiga nisbatan
                </p>
              </div>
              <div class="card-body p-3 chart">
                <canvas id="salesChart" width="100%" height="300"></canvas>
              </div>
            </div>
          </div>

          <!-- Cards Section (Right Side) -->
          <div class="col-lg-4">
            <div class="row">
              <!-- Total Services Card -->
              <div class="col-md-6 col-lg-12 mb-4">
                <div class="card h-100">
                  <div class="card-body p-3">
                    <div class="row">
                      <div class="col-8">
                        <div class="numbers">
                          <p class="text-sm mb-0 text-uppercase font-weight-bold">o'rtacha foyda</p>
                          <h5 class="font-weight-bolder">565</h5>
                        </div>
                      </div>
                      <div class="col-4 text-end">
                        <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                          <i class="ni ni-money-coins text-lg opacity-10" aria-hidden="true"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Product Count Card -->
              <div class="col-md-6 col-lg-12 mb-4">
                <div class="card h-100">
                  <div class="card-body p-3">
                    <div class="row">
                      <div class="col-8">
                        <div class="numbers">
                          <p class="text-sm mb-0 text-uppercase font-weight-bold">Eng yaxshi xaridor</p>
                          <h5 class="font-weight-bolder">{{top_by_sum.umumiy_summa|human_format }} so'm <span
                              style="color: blue;">{{top_by_quantity.name}}</span></h5>
                        </div>
                      </div>
                      <div class="col-4 text-end">
                        <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle">
                          <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Total Revenue Card -->
              <div class="col-md-6 col-lg-12 mb-4">
                <div class="card h-100">
                  <div class="card-body p-3">
                    <div class="row">
                      <div class="col-8">
                        <div class="numbers">
                          <p class="text-sm mb-0 text-uppercase font-weight-bold">oylik chiqim</p>
                          <h5 class="font-weight-bolder">{{ current_month_chiqim|intcomma }}
                            <span style="font-size: 12px;">
                              <i style="font-size: 10px;" class="bi bi-arrow-down fs-7"></i>
                              <span class="change-indicator">
                                {{last_chiqim_foiz}}
                                <span class="change-tooltip" style="font-size: 12px;">O'tgan oyga nisbatan
                                  {{last_chiqim_foiz}} kam. Oldingi oyda {{last_month_chiqim|human_format}} so'm chiqim
                                  qilingan</span>
                              </span>
                            </span>
                          </h5>
                        </div>
                      </div>
                      <div class="col-4 text-end">
                        <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                          <i class="ni ni-paper-diploma text-lg opacity-10" aria-hidden="true"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <style>
                .change-indicator {
                  position: relative;
                  cursor: pointer;
                  text-decoration: underline dotted;
                }

                .change-tooltip {
                  position: absolute;
                  bottom: 100%;
                  left: 50%;
                  transform: translateX(-50%);
                  width: 200px;
                  background: #333;
                  color: white;
                  padding: 8px;
                  border-radius: 4px;
                  font-size: 12px;
                  opacity: 0;
                  visibility: hidden;
                  transition: all 0.3s;
                  z-index: 100;
                  margin-bottom: 5px;
                }

                .change-indicator:hover .change-tooltip {
                  opacity: 1;
                  visibility: visible;
                }
              </style>
              <!-- Profit Card -->
              <div class="col-md-6 col-lg-12">
                <div class="card h-100">
                  <div class="card-body p-3">
                    <div class="row">
                      <div class="col-8">
                        <div class="numbers">
                          <p class="text-sm mb-0 text-uppercase font-weight-bold">berilishi kerak</p>
                          <h5 class="font-weight-bolder">{{ total_oyliklar|intcomma }} so'm</h5>
                        </div>
                      </div>
                      <div class="col-4 text-end">
                        <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">
                          <i class="ni ni-cart text-lg opacity-10" aria-hidden="true"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const ctx = document.getElementById('salesChart').getContext('2d');
      try {
        const response = await fetch('/dashbort/api/weekly-works/');
        if (!response.ok) throw new Error('Network response was not ok');
        const jsonData = await response.json();

        // Tarjimasi
        const uzbekLabels = {
          "kosib": "Kosib",
          "zakatovka": "Zakatovka",
          "kroy": "Kroy",
          "pardozchi": "Pardozchi"
        };

        // Datasetlar labelini tarjima qilamiz
        jsonData.datasets.forEach(ds => {
          ds.label = uzbekLabels[ds.label] || ds.label;
        });

        const chartData = {
          labels: jsonData.labels,
          datasets: jsonData.datasets
        };

        new Chart(ctx, {
          type: 'line',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: "white" }
              },
              tooltip: {
                enabled: true,
                mode: 'index',
                intersect: false
              }
            },
            scales: {
              x: {
                type: 'category',
                ticks: { color: "white", autoSkip: true, maxRotation: 0 }
              },
              y: {
                ticks: { color: "white" }
              }
            },
            animation: {
              duration: 1000,
              easing: 'easeInOutQuad'
            }
          }
        });

      } catch (error) {
        console.error('Xatolik yuz berdi:', error);
      }
    });
  </script>
  <style>
    #salesChart {
      background-color: black;
      padding: 10px;
      border-radius: 10px;
    }
  </style>
  <div class="col-md-6 mb-lg-0 mb-4">
    <div class="card mt-4">
      <div class="card m-50">
        <div class="d-flex justify-content-center align-items-center p-3 gap-3">
          <!-- Kosib uchun icon va ma'lumot -->
          <div class="text-center">
            <div class="icon icon-shape icon-lg bg-primary shadow text-center border-radius-lg">
              <i class="fas fa-hammer opacity-10 "></i> <!-- Kosib iconi -->
            </div>
            <h6 class="text-center mb-0 mt-2">Kosib</h6>
            <h5 class="mb-0">{{ umumiy_kosib | intcomma }} ta</h5>
          </div>

          <!-- Zakatovka uchun icon va ma'lumot -->
          <div class="text-center">
            <div class="icon icon-shape icon-lg bg-gradient-success shadow text-center border-radius-lg">
              <i class="fas fa-tools opacity-10"></i> <!-- Zakatovka iconi -->
            </div>
            <h6 class="text-center mb-0 mt-2">Zakatovka</h6>
            <h5 class="mb-0">{{ umumiy_z | intcomma }} ta</h5>
          </div>

          <!-- Kroy uchun icon va ma'lumot -->
          <div class="text-center">
            <div class="icon icon-shape icon-lg bg-warning shadow text-center border-radius-lg">
              <i class="fas fa-cut opacity-10"></i> <!-- Kroy iconi -->
            </div>
            <h6 class="text-center mb-0 mt-2">Kroy</h6>
            <h5 class="mb-0">{{ umumiy_k | intcomma }} ta</h5>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card bg-dark text-white h-100 mt-2">
    <div class="card-header border-bottom">
      <h5 class="mb-0">Oylik sotuvlar statistikasi</h5>
      <p class="text-sm mb-0 text-white-50">Oxirgi 3 oy ma'lumoti</p>
    </div>
    <div class="card-body p-3">
      <div class="chart-container" style="height: 300px;">
        <canvas id="monthlySalesChart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      fetch('/dashbort/api/monthly-sales/')
        .then(response => response.json())
        .then(data => {
          const ctx = document.getElementById('monthlySalesChart').getContext('2d');

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: [
                {
                  label: 'Sotilgan mahsulotlar (dona)',
                  data: data.kirim_data,
                  backgroundColor: 'rgba(54, 162, 235, 0.7)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1
                },
                {
                  label: 'Buyurtmalar soni',
                  data: data.order_data,
                  backgroundColor: 'rgba(255, 99, 132, 0.7)',
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 1
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: 'rgba(255, 255, 255, 0.7)'
                  },
                  grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                  }
                },
                x: {
                  ticks: {
                    color: 'rgba(255, 255, 255, 0.7)'
                  },
                  grid: {
                    display: false
                  }
                }
              },
              plugins: {
                legend: {
                  labels: {
                    color: 'rgba(255, 255, 255, 0.7)'
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.dataset.label || '';
                      if (label) {
                        label += ': ';
                      }
                      label += context.parsed.y;
                      return label;
                    }
                  }
                }
              }
            }
          });
        });
    });
  </script>


  </div>
  <div class="row">
    <div class="col-md-7 mt-4">
      <div class="card">
        <div class="card-header pb-0 px-3">
          <h6 class="mb-0">Xaridorlar</h6>
        </div>
        <div class="card-body pt-4 p-3">
          {% for i in xaridor %}
          <ul class="list-group">
            <li class="list-group-item border-0 d-flex p-4 mb-2 bg-gray-100 border-radius-lg">
              <a href="{% url 'main:xaridor_detail' i.id%}">
                <div class="d-flex flex-column">
                  <h6 class="mb-3 text-sm">About</h6>
                  <span class="mb-2 text-xs">Ism: <span
                      class="text-dark font-weight-bold ms-sm-2">{{i.name}}</span></span>
                  <span class="mb-2 text-xs">Telefon: <span class="text-dark ms-sm-2 font-weight-bold">{{i.telefon
                      }}</span></span>
                  <span class="text-xs">Umumiy savdo: <span
                      class="text-dark ms-sm-2 font-weight-bold">{{i.umumiy_summa|intcomma}}</span></span>
                </div>
              </a>
              <div class="ms-auto text-end">
                <a class="btn btn-link text-danger text-gradient px-3 mb-0" href="javascript:;"><i
                    class="far fa-trash-alt me-2"></i>Delete</a>
                <a class="btn btn-link text-dark px-3 mb-0" href="{% url 'main:xaridor_detail' i.id%}"><i
                    class="fas fa-pencil-alt text-dark me-2" aria-hidden="true"></i>Edit</a>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-md-5 mt-4">
      <div class="card h-100 mb-4">
        <div class="card-header pb-0 px-3">
          <div class="row">
            <div class="col-md-6">
              <h6 class="mb-0">Your Transaction's</h6>
            </div>
            <div class="col-md-6 d-flex justify-content-end align-items-center">
              <i class="far fa-calendar-alt me-2"></i>
              <small>23 - 30 March 2020</small>
            </div>
          </div>
        </div>
        <div class="card-body pt-4 p-3">
          <h6 class="text-uppercase text-body text-xs font-weight-bolder mb-3">Newest</h6>
          {% for i in kirim %}
          <ul class="list-group">
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <button
                  class="btn btn-icon-only btn-rounded btn-outline-success mb-0 me-3 btn-sm d-flex align-items-center justify-content-center"><i
                    class="fas fa-arrow-up"></i></button>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">{{i.mahsulot.nomi}} - {{i.xaridor.name }}</h6>
                  <span class="text-xs">{{i.sana}}</span>
                </div>
              </div>
              <div class="d-flex align-items-center text-success text-gradient text-sm font-weight-bold">
                + {{i.summa|intcomma}} so'm
              </div>
            </li>
          </ul>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <footer class="footer pt-3  ">
    <div class="container-fluid">
      <div class="row align-items-center justify-content-lg-between">
        <div class="col-lg-6 mb-lg-0 mb-4">
          <div class="copyright text-center text-sm text-muted text-lg-start">
            Â©
            <script>
              document.write(new Date().getFullYear())
            </script>,
            made with <i class="fa fa-heart"></i> by
            <a href="https://www.creative-tim.com" class="font-weight-bold" target="_blank">Creative Tim</a>
            for a better web.
          </div>
        </div>
        <div class="col-lg-6">
          <ul class="nav nav-footer justify-content-center justify-content-lg-end">
            <li class="nav-item">
              <a href="https://www.creative-tim.com" class="nav-link text-muted" target="_blank">Creative Tim</a>
            </li>
            <li class="nav-item">
              <a href="https://www.creative-tim.com/presentation" class="nav-link text-muted" target="_blank">About
                Us</a>
            </li>
            <li class="nav-item">
              <a href="https://www.creative-tim.com/blog" class="nav-link text-muted" target="_blank">Blog</a>
            </li>
            <li class="nav-item">
              <a href="https://www.creative-tim.com/license" class="nav-link pe-0 text-muted"
                target="_blank">License</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>
  </div>
  </main>
  <div class="fixed-plugin">
    <a class="fixed-plugin-button text-dark position-fixed px-3 py-2">
      <i class="fa fa-cog py-2"> </i>
    </a>
    <div class="card shadow-lg ">
      <div class="card-header pb-0 pt-3 ">
        <div class="float-start">
          <h5 class="mt-3 mb-0">Soft UI Configurator</h5>
          <p>See our dashboard options.</p>
        </div>
        <div class="float-end mt-4">
          <button class="btn btn-link text-dark p-0 fixed-plugin-close-button">
            <i class="fa fa-close"></i>
          </button>
        </div>
        <!-- End Toggle Button -->
      </div>
      <hr class="horizontal dark my-1">
      <div class="card-body pt-sm-3 pt-0">
        <!-- Sidebar Backgrounds -->
        <div>
          <h6 class="mb-0">Sidebar Colors</h6>
        </div>
        <a href="javascript:void(0)" class="switch-trigger background-color">
          <div class="badge-colors my-2 text-start">
            <span class="badge filter bg-primary active" data-color="primary" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-dark" data-color="dark" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-info" data-color="info" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-success" data-color="success" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-warning" data-color="warning" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-danger" data-color="danger" onclick="sidebarColor(this)"></span>
          </div>
        </a>
        <!-- Sidenav Type -->
        <div class="mt-3">
          <h6 class="mb-0">Sidenav Type</h6>
          <p class="text-sm">Choose between 2 different sidenav types.</p>
        </div>
        <div class="d-flex">
          <button class="btn btn-primary w-100 px-3 mb-2 active" data-class="bg-transparent"
            onclick="sidebarType(this)">Transparent</button>
          <button class="btn btn-primary w-100 px-3 mb-2 ms-2" data-class="bg-white"
            onclick="sidebarType(this)">White</button>
        </div>
        <p class="text-sm d-xl-none d-block mt-2">You can change the sidenav type just on desktop view.</p>
        <!-- Navbar Fixed -->
        <div class="mt-3">
          <h6 class="mb-0">Navbar Fixed</h6>
        </div>
        <div class="form-check form-switch ps-0">
          <input class="form-check-input mt-1 ms-auto" type="checkbox" id="navbarFixed" onclick="navbarFixed(this)">
        </div>
        <hr class="horizontal dark my-sm-4">
        <a class="btn bg-gradient-dark w-100" href="https://www.creative-tim.com/product/soft-ui-dashboard">Free
          Download</a>
        <a class="btn btn-outline-dark w-100"
          href="https://www.creative-tim.com/learning-lab/bootstrap/license/soft-ui-dashboard">View documentation</a>
        <div class="w-100 text-center">
          <a class="github-button" href="https://github.com/creativetimofficial/soft-ui-dashboard"
            data-icon="octicon-star" data-size="large" data-show-count="true"
            aria-label="Star creativetimofficial/soft-ui-dashboard on GitHub">Star</a>
          <h6 class="mt-3">Thank you for sharing!</h6>
          <a href="https://twitter.com/intent/tweet?text=Check%20Soft%20UI%20Dashboard%20made%20by%20%40CreativeTim%20%23webdesign%20%23dashboard%20%23bootstrap5&amp;url=https%3A%2F%2Fwww.creative-tim.com%2Fproduct%2Fsoft-ui-dashboard"
            class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-twitter me-1" aria-hidden="true"></i> Tweet
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.creative-tim.com/product/soft-ui-dashboard"
            class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-facebook-square me-1" aria-hidden="true"></i> Share
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endblock %}